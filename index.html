import React, { useState, useEffect, useRef } from 'react';
import { Crown, Glasses, Heart, Star, Trophy, Clock, Gift, AlertCircle, Volume2, VolumeX } from 'lucide-react';

export default function BracketsStreakApp() {
  const [streak, setStreak] = useState(0);
  const [points, setPoints] = useState(0);
  const [lastCheckin, setLastCheckin] = useState(null);
  const [missions, setMissions] = useState([
    { id: 1, time: '12:00', completed: false, label: 'Mediod√≠a' },
    { id: 2, time: '15:00', completed: false, label: 'Tarde' },
    { id: 3, time: '22:00', completed: false, label: 'Noche' }
  ]);
  const [cosmetics, setCosmetics] = useState({
    hat: false,
    bowtie: false,
    crown: false,
    star: false
  });
  const [equippedCosmetic, setEquippedCosmetic] = useState(null);
  const [showResetModal, setShowResetModal] = useState(false);
  const [musicPlaying, setMusicPlaying] = useState(false);
  const audioRef = useRef(null);

  useEffect(() => {
    const savedData = localStorage.getItem('bracketsData');
    if (savedData) {
      const data = JSON.parse(savedData);
      setStreak(data.streak || 0);
      setPoints(data.points || 0);
      setLastCheckin(data.lastCheckin || null);
      setMissions(data.missions || missions);
      setCosmetics(data.cosmetics || cosmetics);
      setEquippedCosmetic(data.equippedCosmetic || null);
    }
    
    // Inicializar audio
    audioRef.current = new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3');
    audioRef.current.loop = true;
    audioRef.current.volume = 0.3;
  }, []);

  useEffect(() => {
    const data = {
      streak,
      points,
      lastCheckin,
      missions,
      cosmetics,
      equippedCosmetic
    };
    localStorage.setItem('bracketsData', JSON.stringify(data));
  }, [streak, points, lastCheckin, missions, cosmetics, equippedCosmetic]);

  const toggleMusic = () => {
    if (audioRef.current) {
      if (musicPlaying) {
        audioRef.current.pause();
      } else {
        audioRef.current.play().catch(e => console.log('Audio play failed:', e));
      }
      setMusicPlaying(!musicPlaying);
    }
  };

  const resetMissionsIfNewDay = () => {
    const today = new Date().toDateString();
    if (lastCheckin !== today) {
      setMissions(missions.map(m => ({ ...m, completed: false })));
      return true;
    }
    return false;
  };

  const addStreakDay = () => {
    const today = new Date().toDateString();
    if (lastCheckin !== today) {
      setStreak(streak + 1);
      setLastCheckin(today);
      resetMissionsIfNewDay();
    }
  };

  const completeMission = (missionId) => {
    const mission = missions.find(m => m.id === missionId);
    if (!mission.completed) {
      setMissions(missions.map(m => 
        m.id === missionId ? { ...m, completed: true } : m
      ));
      setPoints(points + 10);
      addStreakDay();
    }
  };

  const handleBracketLoss = () => {
    setStreak(0);
    setShowResetModal(false);
    if (audioRef.current && musicPlaying) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
      audioRef.current.play();
    }
  };

  const buyCosmetic = (cosmeticName, cost) => {
    if (points >= cost && !cosmetics[cosmeticName]) {
      setPoints(points - cost);
      setCosmetics({ ...cosmetics, [cosmeticName]: true });
    }
  };

  const completedMissions = missions.filter(m => m.completed).length;
  const isHappy = completedMissions >= 2;

  const ToothCharacter = () => (
    <div className="relative flex items-center justify-center">
      <svg width="150" height="180" viewBox="0 0 150 180" className="drop-shadow-2xl">
        {/* Cuerpo del diente */}
        <defs>
          <linearGradient id="toothGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="#ffffff" />
            <stop offset="100%" stopColor="#f0f0f0" />
          </linearGradient>
        </defs>
        
        {/* Forma del diente */}
        <path
          d="M 75 20 Q 50 20, 40 40 L 40 120 Q 40 140, 50 150 L 65 170 Q 75 180, 85 170 L 100 150 Q 110 140, 110 120 L 110 40 Q 100 20, 75 20"
          fill="url(#toothGradient)"
          stroke="#e0e0e0"
          strokeWidth="2"
        />
        
        {/* Brillo del diente */}
        <ellipse cx="60" cy="50" rx="15" ry="25" fill="white" opacity="0.4" />
        
        {/* Lentes */}
        <g transform="translate(75, 70)">
          <ellipse cx="-18" cy="0" rx="15" ry="18" fill="none" stroke="#333" strokeWidth="3" />
          <ellipse cx="18" cy="0" rx="15" ry="18" fill="none" stroke="#333" strokeWidth="3" />
          <line x1="-3" y1="0" x2="3" y2="0" stroke="#333" strokeWidth="3" />
          <ellipse cx="-18" cy="0" rx="15" ry="18" fill="#87CEEB" opacity="0.3" />
          <ellipse cx="18" cy="0" rx="15" ry="18" fill="#87CEEB" opacity="0.3" />
        </g>
        
        {/* Ojos detr√°s de los lentes */}
        <circle cx="57" cy="70" r="4" fill="#333" className={isHappy ? 'animate-pulse' : ''} />
        <circle cx="93" cy="70" r="4" fill="#333" className={isHappy ? 'animate-pulse' : ''} />
        
        {/* Boca */}
        {isHappy ? (
          <path d="M 60 95 Q 75 105, 90 95" stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round" />
        ) : (
          <line x1="60" y1="95" x2="90" y2="95" stroke="#333" strokeWidth="3" strokeLinecap="round" />
        )}
        
        {/* Sonrojo si est√° feliz */}
        {isHappy && (
          <>
            <circle cx="45" cy="85" r="8" fill="#ff9999" opacity="0.6" />
            <circle cx="105" cy="85" r="8" fill="#ff9999" opacity="0.6" />
          </>
        )}
      </svg>

      {/* Cosm√©tico equipado */}
      <div className="absolute top-0 left-1/2 transform -translate-x-1/2">
        {equippedCosmetic === 'crown' && (
          <Crown className="w-12 h-12 text-yellow-400 -translate-y-4" fill="currentColor" />
        )}
        {equippedCosmetic === 'hat' && (
          <div className="w-20 h-10 bg-red-600 rounded-t-full -translate-y-4 shadow-lg" />
        )}
      </div>
      
      {equippedCosmetic === 'bowtie' && (
        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2">
          <div className="flex gap-1 items-center">
            <div className="w-8 h-5 bg-red-600 rounded-l-full shadow-lg" />
            <div className="w-2 h-5 bg-red-800" />
            <div className="w-8 h-5 bg-red-600 rounded-r-full shadow-lg" />
          </div>
        </div>
      )}
      
      {equippedCosmetic === 'star' && (
        <Star className="absolute -top-2 -right-6 w-10 h-10 text-yellow-400 animate-spin" 
              fill="currentColor" 
              style={{ animationDuration: '3s' }} />
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6 max-w-md mx-auto">
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div className="flex items-center gap-2">
          <Trophy className="w-6 h-6 text-yellow-400" />
          <span className="text-2xl font-bold">{streak} d√≠as</span>
        </div>
        <div className="flex items-center gap-4">
          <button 
            onClick={toggleMusic}
            className="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition"
          >
            {musicPlaying ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
          </button>
          <div className="flex items-center gap-2">
            <Star className="w-6 h-6 text-purple-400" />
            <span className="text-2xl font-bold">{points} pts</span>
          </div>
        </div>
      </div>

      {/* Bot√≥n de alerta bracket perdido */}
      <button
        onClick={() => setShowResetModal(true)}
        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl mb-6 flex items-center justify-center gap-2 transition shadow-lg"
      >
        <AlertCircle className="w-5 h-5" />
        ¬°Se me cay√≥ un bracket!
      </button>

      {/* Modal de confirmaci√≥n */}
      {showResetModal && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-gray-800 rounded-2xl p-6 max-w-sm w-full">
            <h3 className="text-xl font-bold mb-4 text-center">‚ö†Ô∏è ¬øEst√°s seguro?</h3>
            <p className="text-gray-300 text-center mb-6">
              Esto reiniciar√° tu racha a 0 d√≠as. ¬øRealmente se te cay√≥ un bracket?
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowResetModal(false)}
                className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded-lg font-semibold transition"
              >
                Cancelar
              </button>
              <button
                onClick={handleBracketLoss}
                className="flex-1 bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg font-semibold transition"
              >
                S√≠, reiniciar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Mascota */}
      <div className="bg-gray-800 rounded-3xl p-8 mb-6 flex flex-col items-center">
        <ToothCharacter />
        <p className="mt-4 text-lg text-center font-semibold">
          {isHappy ? '¬°Tu diente est√° feliz! üòä' : 'Completa tus misiones ü¶∑'}
        </p>
      </div>

      {/* Misiones */}
      <div className="bg-gray-800 rounded-2xl p-6 mb-6">
        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
          <Clock className="w-5 h-5" />
          Misiones del d√≠a
        </h2>
        <div className="space-y-3">
          {missions.map(mission => (
            <div 
              key={mission.id}
              className={`flex items-center justify-between p-4 rounded-xl transition ${
                mission.completed ? 'bg-green-900/30 border-2 border-green-500' : 'bg-gray-700'
              }`}
            >
              <div>
                <p className="font-semibold">{mission.label}</p>
                <p className="text-sm text-gray-400">{mission.time}</p>
              </div>
              <button
                onClick={() => completeMission(mission.id)}
                disabled={mission.completed}
                className={`px-4 py-2 rounded-lg font-semibold transition ${
                  mission.completed 
                    ? 'bg-green-600 cursor-not-allowed' 
                    : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                {mission.completed ? '‚úì Hecho' : 'Completar'}
              </button>
            </div>
          ))}
        </div>
      </div>

      {/* Tienda */}
      <div className="bg-gray-800 rounded-2xl p-6">
        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
          <Gift className="w-5 h-5" />
          Tienda de Cosm√©ticos
        </h2>
        <div className="grid grid-cols-2 gap-3">
          {[
            { name: 'crown', label: 'Corona', cost: 50, icon: Crown },
            { name: 'hat', label: 'Sombrero', cost: 30, icon: Heart },
            { name: 'bowtie', label: 'Corbat√≠n', cost: 40, icon: Gift },
            { name: 'star', label: 'Estrella', cost: 60, icon: Star }
          ].map(item => (
            <div key={item.name} className="bg-gray-700 rounded-xl p-4 flex flex-col items-center">
              <item.icon className="w-8 h-8 mb-2 text-yellow-400" />
              <p className="text-sm font-semibold mb-1">{item.label}</p>
              <p className="text-xs text-gray-400 mb-2">{item.cost} pts</p>
              {cosmetics[item.name] ? (
                <button
                  onClick={() => setEquippedCosmetic(equippedCosmetic === item.name ? null : item.name)}
                  className={`w-full py-1 rounded-lg text-xs font-semibold transition ${
                    equippedCosmetic === item.name
                      ? 'bg-purple-600'
                      : 'bg-green-900 text-green-300'
                  }`}
                >
                  {equippedCosmetic === item.name ? 'Equipado' : 'Equipar'}
                </button>
              ) : (
                <button
                  onClick={() => buyCosmetic(item.name, item.cost)}
                  disabled={points < item.cost}
                  className={`w-full py-1 rounded-lg text-xs font-semibold transition ${
                    points >= item.cost
                      ? 'bg-blue-600 hover:bg-blue-700'
                      : 'bg-gray-600 cursor-not-allowed'
                  }`}
                >
                  Comprar
                </button>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}